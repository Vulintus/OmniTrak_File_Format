function file_writer = OmniTrakFileWrite_WriteBlock_Dictionary(fid, varargin)

%
% OmniTrakFileWrite_WriteBlock_Dictionary.m
% 
%   copyright 2024, Vulintus, Inc.
%
%   OMNITRAKFILEWRITE_WRITEBLOCK_DICTIONARY opens a new *.OmniTrak format file with the
%   specified filename and passes back a function structure for writing new
%   blocks into the file.
%
%   UPDATE LOG:
%   2024-04-23 - Drew Sloan - Function first created.
%   2025-02-14 - Drew Sloan - Renamed from "OmniTrak_File_Writer" to
%                             "OmniTrakFileWrite_WriteBlock_Dictionary" and
%                             converted from a function structure to a
%                             dictionary for routing write functions.
%


if isempty(varargin)                                                        %If the OFBC dictionary wasn't passed to the function.
    ofbc = Load_OmniTrak_File_Block_Codes;                                  %Load the OmniTrak file format block code libary.
else                                                                        %Otherwise
    ofbc = varargin{1};                                                     %The OFBC dictionary should be the first optional input argument.
end

file_writer = dictionary;                                                   %Create a dictionary to hold function handles.

% CLOCK_FILE_START (0x0006): Computer clock serial date number at file creation (local time).
file_writer{'CLOCK_FILE_START'} = ...
    @(varargin)OmniTrakFileWrite_WriteBlock_DateTime_Event(fid,...
    ofbc('CLOCK_FILE_START'),...
    varargin{:});

% CLOCK_FILE_STOP (0x0007): Computer clock serial date number when the file is closed (local time).
file_writer{'CLOCK_FILE_STOP'} = ...
    @(varargin)OmniTrakFileWrite_WriteBlock_DateTime_Event(fid,...
    ofbc('CLOCK_FILE_STOP'),...
    varargin{:});

% CLOCK_SYNC (0x0016): The current serial date number, millisecond clock reading, and/or microsecond clock reading at a single timepoint.
file_writer{'CLOCK_SYNC'} = ...
    @(port_i, varargin)OmniTrakFileWrite_WriteBlock_CLOCK_SYNC(fid,...
    ofbc('CLOCK_SYNC'),...
    port_i, varargin{:});

% TIME_ZONE_OFFSET (0x0019): Computer clock time zone offset from UTC.
file_writer{'TIME_ZONE_OFFSET'} = ...
    @()OmniTrakFileWrite_WriteBlock_TIME_ZONE_OFFSET(fid,...
    ofbc('TIME_ZONE_OFFSET'));

% SYSTEM_NAME (0x0065): Vulintus system name.
file_writer{'SYSTEM_NAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('SYSTEM_NAME'),...
    str);

% SYSTEM_FW_VER (0x0067): System firmware version, written as characters.
file_writer{'SYSTEM_FW_VER'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('SYSTEM_FW_VER'),...
    str);

% SYSTEM_SN (0x0068): System serial number, written as characters.
file_writer{'SYSTEM_SN'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('SYSTEM_SN'),...
    str);

% COMPUTER_NAME (0x006A): Windows PC computer name.
file_writer{'COMPUTER_NAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('COMPUTER_NAME'),...
    str);

% COM_PORT (0x006B): The COM port of a computer-connected system.
file_writer{'COM_PORT'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('COM_PORT'),...
    str);

% DEVICE_ALIAS (0x006C): Human-readable Adjective + Noun alias/name for the device, assigned by Vulintus during manufacturing.
file_writer{'VULINTUS_ALIAS'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('DEVICE_ALIAS'),...
    str);

% USER_SYSTEM_NAME = 130.
file_writer{'USERSET_ALIAS'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('USER_SYSTEM_NAME'),...
    str);

% CTRL_FW_FILENAME = 141.
file_writer{'CTRL_FW_FILENAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('CTRL_FW_FILENAME'),...
    str);

% CTRL_FW_DATE = 142.
file_writer{'CTRL_FW_DATE'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('CTRL_FW_DATE'),...
    str);

% CTRL_FW_TIME = 143.
file_writer{'CTRL_FW_TIME'} = ...     
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('CTRL_FW_TIME'),...
    str);

% MODULE_FW_FILENAME (0x0090): OTMP Module firmware filename, copied from the macro, written as characters.
file_writer{'MODULE_FW_FILENAME'} = ...
    @(index, str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('MODULE_FW_FILENAME'),...
    index, str);

% MODULE_FW_DATE (0x0091): OTMP Module firmware upload date, copied from the macro, written as characters.
file_writer{'MODULE_FW_DATE'} = ...
    @(index, str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('MODULE_FW_DATE'),...
    index, str);

% MODULE_FW_TIME (0x0092): OTMP Module firmware upload time, copied from the macro, written as characters.
file_writer{'MODULE_FW_TIME'} = ...
    @(index, str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('MODULE_FW_TIME'),...
    index, str);

% MODULE_NAME (0x0093): OTMP module name, written as characters.
file_writer{'MODULE_NAME'} = ...
    @(index, str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('MODULE_NAME'),...
    index, str);

% MODULE_SKU (0x0094): OTMP Module SKU, typically written as 4 characters.
file_writer{'MODULE_SKU'} = ...
    @(index, str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('MODULE_SKU'),...
    index, str);

% MODULE_SN (0x0095): OTMP Module serial number, written as characters.
file_writer{'MODULE_SN'} = ...
    @(index, str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('MODULE_SN'),...
    index, str);

% BATTERY_SOC (0x00AA): Current battery state-of charge, in percent.
file_writer{'BATTERY_SOC'} = ...
    @(index, soc)OmniTrakFileWrite_WriteBlock_uClock_uint16(fid,...
    ofbc('BATTERY_SOC'),...
    index, soc);

% SUBJECT_NAME = 200.
file_writer{'SUBJECT_NAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Long_Character_Block(fid,...
    ofbc('SUBJECT_NAME'),...
    str);

% ADMIN_NAME (0x00E0): Test administrator's name.
file_writer{'ADMIN_NAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Short_Character_Block(fid,...
    ofbc('ADMIN_NAME'),...
    str);

% EXP_NAME = 300.
file_writer{'EXP_NAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Long_Character_Block(fid,...
    ofbc('EXP_NAME'),...
    str);

% STAGE_NAME = 400.
file_writer{'STAGE_NAME'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Long_Character_Block(fid,...
    ofbc('STAGE_NAME'),...
    str);

% STAGE_DESCRIPTION = 401.
file_writer{'STAGE_DESCRIPTION'} = ...
    @(str)OmniTrakFileWrite_WriteBlock_Long_Character_Block(fid,...
    ofbc('STAGE_DESCRIPTION'),...
    str);

% SESSION_PARAMS_JSON (0x0200): Behavioral session parameters structure encoded in JSON format text.
file_writer{'SESSION_PARAMS_JSON'} = ...
    @(varargin)OmniTrakFileWrite_WriteBlock_SESSION_PARAMS_JSON(fid,...
    ofbc('SESSION_PARAMS_JSON'),...
    varargin{:});

% TRIAL_PARAMS_JSON (0x0201): Behavioral trial parameters structure encoded in JSON format text.
file_writer{'TRIAL_PARAMS_JSON'} = ...
    @(varargin)OmniTrakFileWrite_WriteBlock_TRIAL_PARAMS_JSON(fid,...
    ofbc('TRIAL_PARAMS_JSON'),...
    varargin{:});

%Block code: AMBULATION_XY_THETA = 1024.
file_writer{'AMBULATION_XY_THETA'} = ...
    @(timestamp, xy, angle)OmniTrakFileWrite_WriteBlock_AMBULATION_XY_THETA(fid,...
    ofbc('AMBULATION_XY_THETA'),...
    timestamp, xy, angle);

%Block code: TRIAL_START_SERIAL_DATE = 2014.
file_writer{'TRIAL_START_SERIAL_DATE'} = ...
    @(trial_num, varargin)OmniTrakFileWrite_WriteBlock_DateTime_uint16(fid,...
    ofbc('TRIAL_START_SERIAL_DATE'),...
    trial_num, varargin{:});

%Block code: TTL_PULSETRAIN = 2048.
file_writer{'TTL_PULSETRAIN'} = ...
    @(timestamp, chan, volts, dur)OmniTrakFileWrite_WriteBlock_TTL_PULSETRAIN(fid,...
    ofbc('TTL_PULSETRAIN'),...
    timestamp, chan, volts, dur);

% SW_OPERANT_FEED = 2407.
file_writer{'SW_OPERANT_FEED'} = ...
    @(feeder_index)OmniTrakFileWrite_WriteBlock_SW_OPERANT_FEED(fid,...
    ofbc('SW_OPERANT_FEED'),...
    feeder_index);

% POKE_BITMASK = 2560.
file_writer{'POKE_BITMASK'} = ...
    @(micros, num_pokes, bitmask)OmniTrakFileWrite_WriteBlock_Byte_Bitmask(fid,...
    ofbc('POKE_BITMASK'),...
    micros, num_pokes, bitmask);

% CAPSENSE_BITMASK (0x0A10): Capacitive sensor status bitmask, typically 
% written only when it changes.
file_writer{'CAPSENSE_BITMASK'} = ...
    @(micros, num_sensors, bitmask)OmniTrakFileWrite_WriteBlock_Byte_Bitmask(fid,...
    ofbc('CAPSENSE_BITMASK'),...
    micros, num_sensors, bitmask);

% CAPSENSE_VALUE (0x0A11): Capacitive sensor reading for one sensor, in ADC 
% ticks or clock cycles.
file_writer{'CAPSENSE_VALUE'} = ...
    @(micros, index, value, num_sensors, bitmask)OmniTrakFileWrite_WriteBlock_CAPSENSE_VALUE(fid,...
    ofbc('CAPSENSE_VALUE'),...
    micros, index, value, num_sensors, bitmask);

% VIBROTACTILE_DETECTION_TASK_TRIAL (0x0A8D): Vibrotactile detection task 
% trial data.
file_writer{'VIBROTACTILE_DETECTION_TASK_TRIAL'} = ...
    @(varargin)OmniTrakFileWrite_WriteBlock_VIBROTACTILE_DETECTION_TASK_TRIAL(fid,...
    ofbc('VIBROTACTILE_DETECTION_TASK_TRIAL'),...
    varargin{:});

% STAP_2AFC_TASK_TRIAL (0x0AB4): SensiTrak proprioception discrimination 
% task trial outcome data.
file_writer{'STAP_2AFC_TRIAL_OUTCOME'} = ...
    @(varargin)OmniTrakFileWrite_WriteBlock_STAP_2AFC_TRIAL_OUTCOME(fid,...
    ofbc('STAP_2AFC_TRIAL_OUTCOME'),...
    varargin{:});

% FR_TASK_TRIAL (0x0AF0): Fixed reinforcement task trial data.
file_writer{'FR_TASK_TRIAL'} = ...
    @(behavior)OmniTrakFileWrite_WriteBlock_FR_TASK_TRIAL(fid,...
    ofbc('FR_TASK_TRIAL'),...
    behavior);

% CALIBRATION_DATE (0x089C): Most recent calibration date/time, for the 
% specified module index.
file_writer{'CALIBRATION_DATE'} = ...
    @(index, dt)OmniTrakFileWrite_WriteBlock_Indexed_DateTime(fid,...
    ofbc('CALIBRATION_DATE'),...
    index, dt);

% SCOPE_TRACE (0x089C): An oscilloscope recording, in units of volts, from 
% one or multiple channels, with time units in seconds, along with a 
% variable number of parameters describing the recording conditions.
file_writer{'SCOPE_TRACE'} = ...
    @(times, signal, params)OmniTrakFileWrite_WriteBlock_SCOPE_TRACE(fid,...
    ofbc('SCOPE_TRACE'),...
    times, signal, params);


